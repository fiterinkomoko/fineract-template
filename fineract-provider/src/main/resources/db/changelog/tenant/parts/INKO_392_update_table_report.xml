<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements. See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership. The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License. You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied. See the License for the
    specific language governing permissions and limitations
    under the License.

-->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.6.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd">

    <changeSet author="bosco@fiter.io" id="Update_Collateral_report_INKO-392_9" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Collateral';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select&#10;o.name as Office,&#10;c.external_id as UID,&#10;concat(c.firstname, ' ', c.lastname) as 'Customer Name',&#10;l.account_no as 'Loan Id Number',&#10;mpl.name as 'Product Name',&#10;l.principal_amount as 'Loan Amount',&#10;cvs.code_value as Strata,&#10;mcm.quality as 'Type of Collateral',&#10;ccma.worth_of_collateral as 'Collateral Coverage',&#10;'' as OMV,&#10;'' as FSV,&#10;cvp.code_value as Province,&#10;cvd.code_value as District,&#10;cvsec.code_value as Sector,&#10;cvcell.code_value as Cell,&#10;cvv.code_value as Village&#10;from&#10;m_office o&#10;join m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%') and ounder.hierarchy like concat('${currentUserHierarchy}', '%')&#10;join m_client c on c.office_id = ounder.id    &#10;join m_loan l on l.client_id = c.id&#10;join m_product_loan mpl on l.product_id = mpl.id&#10;left join m_client_other_info coi on coi.client_id = c.id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;left join m_loan_collateral_management lcm on lcm.loan_id = l.id&#10;left join m_client_collateral_management mccm on lcm.id = mccm.collateral_id&#10;left join m_collateral_management mcm on mccm.collateral_id = mcm.id&#10;left join m_client_collateral_management_additional_details ccma on ccma.client_collateral_id = lcm.client_collateral_id&#10;left join m_code_value cvp on cvp.id = ccma.province_cv_id&#10;left join m_code_value cvd on cvd.id = ccma.district_cv_id&#10;left join m_code_value cvsec on cvsec.id = ccma.sector_cv_id&#10;left join m_code_value cvcell on cvcell.id = ccma.cell_cv_id&#10;left join m_code_value cvv on cvv.id = ccma.village_cv_id&#10;where&#10;o.id = ${officeId}&#10;and (l.product_id = '${loanProductId}' or '-1' = '${loanProductId}')&#10;and (l.fund_id = '${fundId}' or '-1' = '${fundId}')&#10;and (l.loan_officer_id = '${loanOfficerId}' or '-1' = '${loanOfficerId}')&#10;and (ccma.province_cv_id = '${provinceId}' or '-1' = '${provinceId}')&#10;GROUP BY o.name, c.external_id, CONCAT(c.firstname, ' ', c.lastname), l.account_no, mpl.name, l.principal_amount, mcm.quality, mcm.unit_type, cvp.code_value, cvd.code_value, cvsec.code_value, cvcell.code_value, cvv.code_value,cvs.code_value,ccma.worth_of_collateral&#10;"/>
            <where>report_name = 'Collateral'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Secured_and_Unsecured_loan_report_INKO-393_4" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Secured and Unsecured loan';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select o.name  as 'Office',&#10;cvl.code_value  as 'Location',&#10;concat(c.firstname, ' ', c.lastname) as 'Customer Name',&#10;c.external_id  as 'Client UID',&#10;l.account_no  as 'Loan ID Number',&#10;mpl.name  as 'Product Name',&#10;l.principal_disbursed_derived  as 'Loan Amount',&#10;l.principal_disbursed_derived  as 'Disbursed loan amount',&#10;if(lc.id is not null, 'Yes', 'No')   as 'Collateral',&#10;cdg.code_value  as 'Gender',&#10;cvc.code_value  as 'Cohort',&#10;l.loan_counter  as 'Cycle',&#10;cvn.code_value  as 'Nationality',&#10;l.total_outstanding_derived  as 'Outstanding Loan Amount',&#10;cvs.code_value   as 'Strata'&#10;from m_office o&#10;join m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%') and&#10;ounder.hierarchy like concat('${currentUserHierarchy}', '%')&#10;join m_client c on c.office_id = ounder.id&#10;join m_loan l on l.client_id = c.id&#10;join m_product_loan mpl on l.product_id = mpl.id&#10;left join m_currency cur on cur.code = l.currency_code&#10;left join m_client_other_info coi on coi.client_id = c.id&#10;left join m_code_value cdg on cdg.id = c.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = c.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;left join m_loan_collateral_management lc on lc.loan_id = l.id&#10;where o.id = ${officeId}&#10;and (l.product_id = '${loanProductId}' or '-1' = '${loanProductId}')&#10;and (l.loan_officer_id = '${loanOfficerId}' or '-1' = '${loanOfficerId}')&#10;and (l.currency_code = '${currencyId}' or '-1' = '${currencyId}')&#10;and date(l.disbursedon_date) between date('${startDate}') and date('${endDate}')&#10;"/>
            <where>report_name = 'Secured and Unsecured loan'</where>
        </update>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="add_loan_product_parameter_filter_on_Secured_and_Unsecured_loan_report" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Secured and Unsecured loan')"/>
            <column name="parameter_id" valueComputed="(select sp.id from stretchy_parameter sp where sp.parameter_name = 'loanProductIdSelectAllWithoutCurrency')"/>
            <column name="report_parameter_name" value="loanProductId"/>
        </insert>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="add_generic_loan_counter_in_loan">

        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="m_loan" columnName="generic_loan_counter"/>
            </not>
        </preConditions>
        <addColumn tableName="m_loan">
            <column name="generic_loan_counter" type="int">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Loan-in-arrears-Table_loan_report_INKO-397" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Loan in arrears Table';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select mc.id   AS 'ID',&#10;mc.firstname   AS 'First Name',&#10;mc.middlename    AS 'Middle Name',&#10;mc.lastname    AS 'Last Name',&#10;mc.display_name   AS 'Full Name',&#10;mc.mobile_no    AS 'Mobile No',&#10;ml.principal_amount    AS 'Loan Amount',&#10;(IFNULL(ml.principal_outstanding_derived, 0) + IFNULL(ml.interest_outstanding_derived, 0) + IFNULL(ml.fee_charges_outstanding_derived, 0) + IFNULL(ml.penalty_charges_outstanding_derived, 0))    AS 'Loan Outstanding',&#10;ml.principal_disbursed_derived    AS 'Loan Disbursed',&#10;laa.overdue_since_date_derived     AS 'Payment Due Date',&#10;IFNULL(laa.total_overdue_derived, 0)    AS 'Total Due',&#10;ounder.id    AS 'Office Number',&#10;ml.account_no    AS 'Account Number',&#10;gua.lastname     AS 'Guarantor Last Name',&#10;COUNT(gua.id)   AS 'Number Of Guarantors',&#10;g.display_name   AS 'Group Name',&#10;year(now()) - YEAR(mc.date_of_birth)    as 'Age',&#10;mc.external_id  as 'Client UID',&#10;cdg.code_value   as 'Gender',&#10;cvc.code_value   as 'Cohort',&#10;ml.generic_loan_counter   as 'Cycle',&#10;cvn.code_value    as 'Nationality',&#10;cvl.code_value   as 'Location',&#10;cvs.code_value   as 'Strata'&#10;FROM m_office mo&#10;JOIN m_office ounder ON ounder.hierarchy LIKE CONCAT(mo.hierarchy, '%')&#10;INNER JOIN m_client mc ON mc.office_id = ounder.id&#10;INNER JOIN m_loan ml ON ml.client_id = mc.id&#10;INNER JOIN r_enum_value rev ON rev.enum_id = ml.loan_status_id AND rev.enum_name = 'loan_status_id'&#10;INNER JOIN m_loan_arrears_aging laa ON laa.loan_id = ml.id&#10;LEFT JOIN m_currency cur ON cur.code = ml.currency_code&#10;LEFT JOIN m_group_client gc ON gc.client_id = mc.id&#10;LEFT JOIN m_group g ON g.id = gc.group_id&#10;LEFT JOIN m_staff lo ON lo.id = ml.loan_officer_id&#10;LEFT JOIN m_guarantor gua ON gua.loan_id = ml.id&#10;left join m_client_other_info coi on coi.client_id = mc.id&#10;left join m_code_value cdg on cdg.id = mc.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = mc.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;WHERE ml.loan_status_id = 300&#10;AND mo.id = ${officeId}&#10;AND (IFNULL(ml.loan_officer_id, -10) = ${loanOfficerId} OR '-1' = '${loanOfficerId}')&#10;AND (DATEDIFF(CURDATE(), laa.overdue_since_date_derived) BETWEEN '${fromX}' AND '${toY}')&#10;GROUP BY ml.id, ounder.hierarchy, ml.currency_code, mc.account_no, ml.account_no, gua.lastname, g.display_name,&#10;cvc.code_value, cvn.code_value, cvl.code_value, cvs.code_value&#10;ORDER BY ounder.hierarchy, ml.currency_code, mc.account_no, ml.account_no&#10;"/>
            <where>report_name = 'Loan in arrears Table'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Obligation-Met-Loans-Details-Table_loan_report_INKO-396" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Obligation Met Loans Details';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select concat(repeat('..',  ((LENGTH(ounder.hierarchy) - LENGTH(REPLACE(ounder.hierarchy, '.', '')) - 1))), ounder.name) as 'Office/Branch',&#10;ifnull(cur.display_symbol, l.currency_code) as 'Currency',&#10;c.account_no as 'Client Account No.',&#10;c.display_name as 'Client',&#10;l.account_no as 'Loan Account No.',&#10;pl.name as 'Product',&#10;f.name as 'Fund',&#10;l.principal_amount as 'Loan Amount',&#10;l.total_repayment_derived  as 'Total Repaid',&#10;l.annual_nominal_interest_rate as 'Annual Nominal Interest Rate',&#10;date(l.disbursedon_date) as 'Disbursed',&#10;date(l.closedon_date) as 'Closed',&#10;l.principal_repaid_derived as 'Principal Repaid',&#10;l.interest_repaid_derived as 'Interest Repaid',&#10;l.fee_charges_repaid_derived as 'Fees Repaid',&#10;l.penalty_charges_repaid_derived as 'Penalties Repaid',&#10;lo.display_name as 'Loan Officer',&#10;cvl.code_value     as 'Location',&#10;l.generic_loan_counter     as 'Cycle'&#10;from m_office o&#10;join m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')&#10;and ounder.hierarchy like concat('${currentUserHierarchy}', '%')&#10;join m_client c on c.office_id = ounder.id&#10;join m_loan l on l.client_id = c.id&#10;join m_product_loan pl on pl.id = l.product_id&#10;left join m_staff lo on lo.id = l.loan_officer_id&#10;left join m_currency cur on cur.code = l.currency_code&#10;left join m_fund f on f.id = l.fund_id&#10;left join m_client_recruitment_survey crs on crs.client_id = c.id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;where o.id = ${officeId}&#10;and (l.currency_code = '${currencyId}' or '-1' = '${currencyId}')&#10;and (l.product_id = '${loanProductId}' or '-1' = '${loanProductId}')&#10;and (ifnull(l.loan_officer_id, -10) = '${loanOfficerId}' or '-1' = '${loanOfficerId}')&#10;and (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})&#10;and (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})&#10;and (case	when ${obligDateType} = 1 then    l.closedon_date between '${startDate}' and '${endDate}'	when ${obligDateType} = 2 then    l.disbursedon_date between '${startDate}' and '${endDate}'	else 1 = 1	end)&#10;and l.loan_status_id = 600&#10;group by l.id,ounder.hierarchy, l.currency_code, c.account_no, l.account_no,cvl.code_value&#10;order by ounder.hierarchy, l.currency_code, c.account_no, l.account_no&#10;"/>
            <where>report_name = 'Obligation Met Loans Details'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Portfolio-Management-Report-Table_loan_report_INKO-398" context="mysql">
        <sqlFile
                encoding="utf8"
                path="db/changelog/tenant/commands/update_portfolio_management_table_reports.sql"
                relativeToChangelogFile="false"
                splitStatements="true"
                stripComments="true"/>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="Update_Rescheduled-Loans_report_INKO-417" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Rescheduled Loans';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT concat(repeat('..', ((LENGTH(ounder.hierarchy) - LENGTH(REPLACE(ounder.hierarchy, '.', '')) - 1))), ounder.name)   as 'Office/Branch',&#10;coalesce(cur.display_symbol, ml.currency_code)  as 'Currency',&#10;c.account_no  as 'Client Account No.',&#10;c.display_name  AS 'Client Name',&#10;ml.account_no  AS 'Loan Account No.',&#10;mpl.name  AS 'Product Name',&#10;ml.disbursedon_date  AS 'Disbursed Date',&#10;lt.transaction_date    AS 'Written Off date',&#10;ml.principal_amount  as 'Loan Amount',&#10;coalesce(lt.principal_portion_derived, 0)  AS 'Rescheduled Principal',&#10;coalesce(lt.interest_portion_derived, 0)    AS 'Rescheduled Interest',&#10;coalesce(lt.fee_charges_portion_derived, 0)   AS 'Rescheduled Fees',&#10;coalesce(lt.penalty_charges_portion_derived, 0)    AS 'Rescheduled Penalties',&#10;join_mlrr.comment   AS 'Reason For Rescheduling',&#10;coalesce(ms.display_name, '-')   AS 'Loan Officer Name',&#10; extract(year from now()) - extract(year from c.date_of_birth) as 'Age',&#10; c.external_id    as 'Client UID',&#10; cdg.code_value    as 'Gender',&#10;cvc.code_value   as 'Cohort',&#10;ml.generic_loan_counter   as 'Cycle',&#10;cvn.code_value   as 'Nationality',&#10;cvl.code_value     as 'Location',&#10;cvs.code_value     AS 'Strata',&#10;ml.loan_status_id     AS 'Loan Status'&#10;FROM m_office o &#10;JOIN m_office ounder ON ounder.hierarchy like concat(o.hierarchy, '%') AND  ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')&#10;JOIN m_client c ON c.office_id = ounder.id&#10;JOIN m_loan ml ON ml.client_id = c.id&#10;JOIN m_product_loan mpl ON mpl.id = ml.product_id&#10;JOIN m_loan_transaction lt ON lt.loan_id = ml.id&#10;JOIN (SELECT MAX(mlrr.id) AS id, mlrr.loan_id, mlrr.reschedule_reason_comment as comment&#10;FROM m_loan_reschedule_request mlrr&#10;WHERE mlrr.status_enum = 200&#10;GROUP BY mlrr.loan_id, mlrr.reschedule_reason_comment) join_mlrr ON join_mlrr.loan_id = ml.id&#10;LEFT JOIN m_staff ms ON ms.id = ml.loan_officer_id&#10;LEFT JOIN m_note n ON n.loan_transaction_id = lt.id&#10;LEFT JOIN m_currency cur on cur.code = ml.currency_code&#10;left join m_client_other_info coi on coi.client_id = c.id&#10;left join m_code_value cdg on cdg.id = c.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = c.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;WHERE lt.is_reversed is false&#10;AND o.id = ${officeId}&#10;AND (mpl.id = ${loanProductId} OR ${loanProductId} = -1)&#10;AND lt.transaction_date BETWEEN '${startDate}' AND '${endDate}'&#10;AND (ml.currency_code = '${currencyId}' or '-1' = '${currencyId}')&#10;ORDER BY ounder.hierarchy, coalesce(cur.display_symbol, ml.currency_code), ml.account_no&#10;"/>
            <where>report_name = 'Rescheduled Loans'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_IC-Minutes_report_INKO-400" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'IC Minutes';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select c.external_id      as 'Client UID', concat(c.firstname, c.lastname)       as 'Client/Company Name', &#10;l.generic_loan_counter      as 'Cycle', &#10;cvg.code_value        as 'Gender', &#10;cvs.code_value      as 'Strata', &#10;cvb.code_value    as 'Business Sector',&#10;loanPurposeTble.code_value    as 'Purpose of the loan',&#10;l.principal_amount_proposed    as 'Applied Amount', &#10;icReviewTbl.IC_Level_One      as 'IC Decision Level One',&#10;icReviewTbl.IC_Level_Two     as 'IC Decision Level Two',&#10;icReviewTbl.IC_Level_Three     as 'IC Decision Level Three', &#10;icReviewTbl.IC_Level_Four    as 'IC Decision Level Four',&#10;icReviewTbl.IC_Level_Five   as 'IC Decision Level Five', &#10;l.approved_principal     as 'IC Approved Amount',&#10;l.term_frequency      as 'Loan Tenure in months', &#10;''       as 'IC Approved Amount in Words',&#10;l.principal_disbursed_derived         as 'Installment Amount', &#10;l.penalty_charges_charged_derived     as 'Late Fees',&#10;coi.tax_identification_number         as 'Company Tin Number', &#10;cvn.code_value      as 'Nationality',&#10;villageTbl.code_value     as 'Village',&#10;cellTbl.code_value     as 'Cell', &#10;cvb.code_value      as 'Sector',&#10;districtTbl.code_value    as 'District', &#10;coi.telephone_no      as 'Contact Number', &#10;coi.co_signors      as 'Cosigner Number', &#10;l.account_no      as 'Loan ID Number', &#10;coi.bank_account_number    as 'Bank Account Number', &#10;coi.bank_name   as 'Bank Name', &#10;ccma.UPI_NO     as 'UPI Number',&#10;cvp.code_value    as 'Province', &#10;ccma.collateral_owner_first           as 'Owners Name 1', &#10;ccma.collateral_owner_second          as 'Owners Name 2', &#10;ccma.id_no_of_collateral_owner_first  as 'Owners ID 1', &#10;ccma.id_no_of_collateral_owner_second as 'Owners ID 2', &#10; ''      as 'OMV Figures', &#10;''      as 'OMV in letters', &#10;coi.guarantor  as 'Witness Name' &#10;from m_office o &#10;join m_office ounder ON ounder.hierarchy like concat(o.hierarchy, '%') AND  ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')  &#10;join m_client c ON c.office_id = ounder.id  &#10;join m_loan l ON l.client_id = c.id &#10;left join m_loan_arrears_aging laa on laa.loan_id = l.id &#10;join m_product_loan p ON p.id = l.product_id &#10;left join m_code_value cvg ON cvg.id = c.gender_cv_id &#10;left join m_client_other_info coi ON coi.client_id = c.id  &#10;left join m_client_recruitment_survey crs on crs.client_id = c.id &#10;left join m_code_value cvn ON cvn.id = coi.nationality_cv_id  &#10;left join m_code_value cvs ON cvs.id = coi.strata_cv_id  &#10;left join m_business_detail bd on bd.client_id = c.id  &#10;left join m_code_value cvb on cvb.id = bd.business_type_id  &#10;left join m_loan_collateral_management lcm on lcm.loan_id = l.id  &#10;left join m_client_collateral_management_additional_details ccma  on ccma.client_collateral_id = lcm.client_collateral_id  &#10; left join m_code_value cvp on cvp.id = ccma.province_cv_id  &#10; left join m_code_value loanPurposeTble on loanPurposeTble.id = l.loanpurpose_cv_id  &#10;left join m_code_value villageTbl on villageTbl.id = ccma.village_cv_id  &#10;left join m_code_value districtTbl on districtTbl.id = ccma.district_cv_id   &#10;left join m_code_value cellTbl on cellTbl.id = ccma.cell_cv_id  &#10;left join (select ld.loan_id, &#10;case &#10;when ld.loan_decision_state = 1000 then 'Review Application' &#10;when ld.loan_decision_state = 1200 then 'Due Diligence' &#10;when ld.loan_decision_state = 1300 then 'Collateral Review' &#10;when ld.loan_decision_state = 1400 then 'IC Review Level One' &#10;when ld.loan_decision_state = 1500 then 'IC Review Level Two'  &#10;when ld.loan_decision_state = 1600 then 'IC Review Level Three' &#10;when ld.loan_decision_state = 1700 then 'IC Review Level Four' &#10;when ld.loan_decision_state = 1800 then 'IC Review Level Five' &#10;when ld.loan_decision_state = 1900 then 'Prepare And Sign Contract' &#10;end    as loanDecisionState,&#10;ld.next_loan_ic_review_decision_state                                      as 'Next IC Level',&#10;if(ld.is_ic_review_decision_level_one_signed = true, 'Approved',&#10;if(ld.is_reject_ic_review_decision_level_one = true, 'Rejected', ''))   as 'IC_Level_One',&#10;if(ld.is_ic_review_decision_level_two_signed = true, 'Approved', &#10;if(ld.is_reject_ic_review_decision_level_two = true, 'Rejected', ''))   as 'IC_Level_Two', &#10;if(ld.is_ic_review_decision_level_three_signed = true, 'Approved', &#10;if(ld.is_reject_ic_review_decision_level_three = true, 'Rejected', '')) as 'IC_Level_Three', &#10;if(ld.is_ic_review_decision_level_four_signed = true, 'Approved', &#10;if(ld.is_reject_ic_review_decision_level_four = true, 'Rejected', ''))  as 'IC_Level_Four', &#10;if(ld.is_ic_review_decision_level_five_signed = true, 'Approved', &#10;if(ld.is_reject_ic_review_decision_level_five = true, 'Rejected', ''))  as 'IC_Level_Five' &#10;from m_loan_decision ld) as icReviewTbl on icReviewTbl.loan_id = l.id&#10;where o.id = ${officeId}&#10;and (l.product_id = '${loanProductId}' or '-1' = '${loanProductId}')&#10;and (ifnull(l.loan_officer_id, -10) = '${loanOfficerId}' or '-1' = '${loanOfficerId}')&#10;and (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})&#10;and (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})&#10;and (date(l.submittedon_date) between date('${startDate}') and date('${endDate}'))&#10;"/>
            <where>report_name = 'IC Minutes'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Secured_and_Unsecured_loan_report_INKO-393-add-age-and-tenure-1" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Secured and Unsecured loan';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select o.name  as 'Office',&#10;cvl.code_value  as 'Location',&#10;concat(c.firstname, ' ', c.lastname) as 'Customer Name',&#10;c.external_id  as 'Client UID',&#10;FLOOR(DATEDIFF(NOW(), c.date_of_birth) / 365) as  'Age',&#10;l.account_no  as 'Loan ID Number',&#10;mpl.name  as 'Product Name',&#10;l.principal_disbursed_derived  as 'Loan Amount',&#10;l.principal_disbursed_derived  as 'Disbursed loan amount',&#10;if(lc.id is not null, 'Yes', 'No')   as 'Collateral',&#10;cdg.code_value  as 'Gender',&#10;cvc.code_value  as 'Cohort',&#10;l.loan_counter  as 'Cycle',&#10;cvn.code_value  as 'Nationality',&#10;l.total_outstanding_derived  as 'Outstanding Loan Amount',&#10;l.term_frequency  as 'Loan Tenure in months',&#10;cvs.code_value   as 'Strata'&#10;from m_office o&#10;join m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%') and&#10;ounder.hierarchy like concat('${currentUserHierarchy}', '%')&#10;join m_client c on c.office_id = ounder.id&#10;join m_loan l on l.client_id = c.id&#10;join m_product_loan mpl on l.product_id = mpl.id&#10;left join m_currency cur on cur.code = l.currency_code&#10;left join m_client_other_info coi on coi.client_id = c.id&#10;left join m_code_value cdg on cdg.id = c.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = c.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;left join m_loan_collateral_management lc on lc.loan_id = l.id&#10;where o.id = ${officeId}&#10;and (l.product_id = '${loanProductId}' or '-1' = '${loanProductId}')&#10;and (l.loan_officer_id = '${loanOfficerId}' or '-1' = '${loanOfficerId}')&#10;and (l.currency_code = '${currencyId}' or '-1' = '${currencyId}')&#10;and date(l.disbursedon_date) between date('${startDate}') and date('${endDate}')&#10;"/>
            <where>report_name = 'Secured and Unsecured loan'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="add_is_collateral_parameter_filter_on_Secured_and_Unsecured_loan_report-1" context="mysql">
        <insert tableName="stretchy_parameter">
            <column name="parameter_name" value="isCollateral"/>
            <column name="parameter_variable" value="isCollateral"/>
            <column name="parameter_label" value="Is Collateral"/>
            <column name="parameter_displayType" value="select"/>
            <column name="parameter_FormatType" value="number"/>
            <column name="parameter_default" value="-1"/>
            <column name="special" />
            <column name="selectOne"/>
            <column name="selectAll"/>
            <column name="parameter_sql" value="select * from (select -1 as id, 'All' as name  union all select 100 as id, 'Yes' as  name union all select 200 as id, 'No' as name) x order by x.id"/>
            <column name="parent_id"/>
        </insert>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="add_is_collateral_filter_on_Secured_and_Unsecured_loan_report-1" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Secured and Unsecured loan')"/>
            <column name="parameter_id" valueComputed="(select sp.id from stretchy_parameter sp where sp.parameter_name = 'isCollateral')"/>
            <column name="report_parameter_name" value="isCollateral"/>
        </insert>
    </changeSet>


    <changeSet author="bosco@fiter.io" id="Update_Secured_and_Unsecured_loan_report_INKO-393-add-is-collateral-param" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Secured and Unsecured loan';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select o.name  as 'Office',&#10;cvl.code_value  as 'Location',&#10;concat(c.firstname, ' ', c.lastname) as 'Customer Name',&#10;c.external_id  as 'Client UID',&#10;FLOOR(DATEDIFF(NOW(), c.date_of_birth) / 365) as  'Age',&#10;l.account_no  as 'Loan ID Number',&#10;mpl.name  as 'Product Name',&#10;l.principal_disbursed_derived  as 'Loan Amount',&#10;l.principal_disbursed_derived  as 'Disbursed loan amount',&#10;if(lc.id is not null, 'Yes', 'No')   as 'Collateral',&#10;cdg.code_value  as 'Gender',&#10;cvc.code_value  as 'Cohort',&#10;l.loan_counter  as 'Cycle',&#10;cvn.code_value  as 'Nationality',&#10;l.total_outstanding_derived  as 'Outstanding Loan Amount',&#10;l.term_frequency  as 'Loan Tenure in months',&#10;cvs.code_value   as 'Strata'&#10;from m_office o&#10;join m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%') and&#10;ounder.hierarchy like concat('${currentUserHierarchy}', '%')&#10;join m_client c on c.office_id = ounder.id&#10;join m_loan l on l.client_id = c.id&#10;join m_product_loan mpl on l.product_id = mpl.id&#10;left join m_currency cur on cur.code = l.currency_code&#10;left join m_client_other_info coi on coi.client_id = c.id&#10;left join m_code_value cdg on cdg.id = c.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = c.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;left join m_loan_collateral_management lc on lc.loan_id = l.id&#10;where o.id = ${officeId}&#10;and (l.product_id = '${loanProductId}' or '-1' = '${loanProductId}')&#10;and (l.loan_officer_id = '${loanOfficerId}' or '-1' = '${loanOfficerId}')&#10;and (l.currency_code = '${currencyId}' or '-1' = '${currencyId}')&#10;and date(l.disbursedon_date) between date('${startDate}') and date('${endDate}')  &#10;AND ( &#10;CASE &#10;WHEN '${isCollateral}' = 100 THEN lc.id IS NOT NULL &#10; WHEN '${isCollateral}' = 200 THEN lc.id IS NULL &#10;ELSE TRUE &#10;END &#10;)&#10;"/>
            <where>report_name = 'Secured and Unsecured loan'</where>
        </update>
    </changeSet>



    <changeSet author="bosco@fiter.io" id="delete-all-parameters-from-loan-fully-repaid-table-report" context="mysql">
        <delete tableName="stretchy_report_parameter">
            <where>report_id = (SELECT id FROM stretchy_report WHERE report_name = 'Loan fully repaid Table')</where>
        </delete>
    </changeSet>
    <changeSet id="add-branch-or-office-to-Loan-fully-repaid-Table" author="bosco@fiter.io" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Loan fully repaid Table')"/>
            <column name="parameter_id" valueNumeric="5"/>
            <column name="report_parameter_name" value="officeId"/>
        </insert>
    </changeSet>
    <changeSet id="add-loanofficerid-to-Loan-fully-repaid-Table" author="bosco@fiter.io" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Loan fully repaid Table')"/>
            <column name="parameter_id" valueNumeric="6"/>
            <column name="report_parameter_name" value="loanOfficerId"/>
        </insert>
    </changeSet>

    <changeSet id="add-start-date-to-Loan-parameter-fully-repaid-Table-report" author="bosco@fiter.io" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Loan fully repaid Table')"/>
            <column name="parameter_id" valueNumeric="1"/>
            <column name="report_parameter_name" value="startDate"/>
        </insert>
    </changeSet>
    <changeSet id="add-end-date-to-Loan-parameter-fully-repaid-Table-report" author="bosco@fiter.io" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Loan fully repaid Table')"/>
            <column name="parameter_id" valueNumeric="2"/>
            <column name="report_parameter_name" value="endDate"/>
        </insert>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Loan-fully-repaid-Table-report-add-startDate-and-end-date-param" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Loan fully repaid Table';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT c.id     AS 'id',&#10;c.firstname     AS 'firstName', &#10;c.middlename    AS 'middleName', &#10;c.lastname      AS 'lastName', &#10;c.display_name     AS 'fullName', &#10;c.mobile_no      AS 'mobileNo', &#10;l.principal_amount      AS 'loanAmount', &#10;(IFNULL(l.principal_outstanding_derived, 0) + IFNULL(l.interest_outstanding_derived, 0) + &#10;IFNULL(l.fee_charges_outstanding_derived, 0) + &#10;IFNULL(l.penalty_charges_outstanding_derived, 0))    AS 'loanOutstanding', &#10;l.principal_disbursed_derived     AS 'loanDisbursed', &#10;o.id      AS 'officeNumber', &#10;l.account_no    AS 'loanAccountId', &#10;gua.lastname     AS 'guarantorLastName', &#10;COUNT(gua.id)     AS 'numberOfGuarantors', &#10;l.maturedon_date     AS 'dueDate', &#10;laa.total_overdue_derived   AS 'totalDue', &#10;gp.display_name    AS 'groupName', &#10;l.total_repayment_derived      AS 'totalFullyPaid', &#10;year(now()) - YEAR(c.date_of_birth)      as 'Age', &#10;c.external_id     as 'Client UID', &#10;cdg.code_value      as 'Gender', &#10;cvc.code_value      as 'Cohort', &#10;l.loan_counter     as 'Cycle',  &#10;cvn.code_value    as 'Nationality', &#10;cvl.code_value     as 'Location', &#10;cvs.code_value     AS 'Strata'&#10;FROM m_office o&#10;JOIN m_office ounder ON ounder.hierarchy LIKE CONCAT(o.hierarchy, '%')&#10;JOIN m_client c ON c.office_id = ounder.id&#10;JOIN m_loan l ON l.client_id = c.id&#10;LEFT JOIN m_staff lo ON lo.id = l.loan_officer_id&#10;LEFT JOIN m_currency cur ON cur.code = l.currency_code&#10;LEFT JOIN m_group_client gc ON gc.client_id = c.id&#10;LEFT JOIN m_group gp ON gp.id = l.group_id&#10;LEFT JOIN m_guarantor gua ON gua.loan_id = l.id&#10;LEFT JOIN m_loan_arrears_aging laa ON laa.loan_id = l.id&#10;left join m_client_other_info coi on coi.client_id = c.id&#10;left join m_code_value cdg on cdg.id = c.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = c.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;WHERE o.id = ${officeId}&#10;AND (IFNULL(l.loan_officer_id, -10) = ${loanOfficerId} OR '-1' = ${loanOfficerId})&#10;AND date(l.closedon_date) between date('${startDate}') and date('${endDate}')&#10;AND (l.loan_status_id IN (600, 700))&#10;GROUP BY l.id, ounder.hierarchy, l.currency_code, c.account_no, l.account_no, gua.lastname, l.maturedon_date, cvc.code_value,&#10; cvn.code_value, cvl.code_value, cvs.code_value&#10;ORDER BY ounder.hierarchy, l.currency_code, c.account_no, l.account_no&#10;"/>
            <where>report_name = 'Loan fully repaid Table'</where>
        </update>
    </changeSet>


    <changeSet author="bosco@fiter.io" id="delete-all-parameters-from-Loan-in-arrears-Table-report" context="mysql">
        <delete tableName="stretchy_report_parameter">
            <where>report_id = (SELECT id FROM stretchy_report WHERE report_name = 'Loan in arrears Table')</where>
        </delete>
    </changeSet>
    <changeSet id="add-branch-or-office-to-Loan-in-arrears-Table" author="bosco@fiter.io" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Loan in arrears Table')"/>
            <column name="parameter_id" valueNumeric="5"/>
            <column name="report_parameter_name" value="officeId"/>
        </insert>
    </changeSet>
    <changeSet id="add-loanofficerid-to-Loan-in-arrears-Table" author="bosco@fiter.io" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Loan in arrears Table')"/>
            <column name="parameter_id" valueNumeric="6"/>
            <column name="report_parameter_name" value="loanOfficerId"/>
        </insert>
    </changeSet>

    <changeSet id="add-start-date-to-Loan-parameter-Loan-in-arrears-Table-report" author="bosco@fiter.io" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Loan in arrears Table')"/>
            <column name="parameter_id" valueNumeric="1"/>
            <column name="report_parameter_name" value="startDate"/>
        </insert>
    </changeSet>
    <changeSet id="add-end-date-to-Loan-parameter-Loan-in-arrears-Table-report" author="bosco@fiter.io" context="mysql">
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select sr.id from stretchy_report sr where sr.report_name ='Loan in arrears Table')"/>
            <column name="parameter_id" valueNumeric="2"/>
            <column name="report_parameter_name" value="endDate"/>
        </insert>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Loan-in-arrears-Table-report-add-startDate-and-end-date-param" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Loan in arrears Table';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select mc.id   AS 'ID',&#10;mc.firstname   AS 'First Name',&#10;mc.middlename    AS 'Middle Name',&#10;mc.lastname    AS 'Last Name',&#10;mc.display_name   AS 'Full Name',&#10;mc.mobile_no    AS 'Mobile No',&#10;ml.principal_amount    AS 'Loan Amount',&#10;(IFNULL(ml.principal_outstanding_derived, 0) + IFNULL(ml.interest_outstanding_derived, 0) + IFNULL(ml.fee_charges_outstanding_derived, 0) + IFNULL(ml.penalty_charges_outstanding_derived, 0))    AS 'Loan Outstanding',&#10;ml.principal_disbursed_derived    AS 'Loan Disbursed',&#10;laa.overdue_since_date_derived     AS 'Payment Due Date',&#10;IFNULL(laa.total_overdue_derived, 0)    AS 'Total Due',&#10;ounder.id    AS 'Office Number',&#10;ml.account_no    AS 'Account Number',&#10;gua.lastname     AS 'Guarantor Last Name',&#10;COUNT(gua.id)   AS 'Number Of Guarantors',&#10;g.display_name   AS 'Group Name',&#10;year(now()) - YEAR(mc.date_of_birth)    as 'Age',&#10;mc.external_id  as 'Client UID',&#10;cdg.code_value   as 'Gender',&#10;cvc.code_value   as 'Cohort',&#10;ml.generic_loan_counter   as 'Cycle',&#10;cvn.code_value    as 'Nationality',&#10;cvl.code_value   as 'Location',&#10;cvs.code_value   as 'Strata'&#10;FROM m_office mo&#10;JOIN m_office ounder ON ounder.hierarchy LIKE CONCAT(mo.hierarchy, '%')&#10;INNER JOIN m_client mc ON mc.office_id = ounder.id&#10;INNER JOIN m_loan ml ON ml.client_id = mc.id&#10;INNER JOIN r_enum_value rev ON rev.enum_id = ml.loan_status_id AND rev.enum_name = 'loan_status_id'&#10;INNER JOIN m_loan_arrears_aging laa ON laa.loan_id = ml.id&#10;LEFT JOIN m_currency cur ON cur.code = ml.currency_code&#10;LEFT JOIN m_group_client gc ON gc.client_id = mc.id&#10;LEFT JOIN m_group g ON g.id = gc.group_id&#10;LEFT JOIN m_staff lo ON lo.id = ml.loan_officer_id&#10;LEFT JOIN m_guarantor gua ON gua.loan_id = ml.id&#10;left join m_client_other_info coi on coi.client_id = mc.id&#10;left join m_code_value cdg on cdg.id = mc.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = mc.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;WHERE ml.loan_status_id = 300&#10;AND mo.id = ${officeId}&#10;AND (IFNULL(ml.loan_officer_id, -10) = ${loanOfficerId} OR '-1' = '${loanOfficerId}')&#10;AND date(laa.overdue_since_date_derived) between date('${startDate}') and date('${endDate}')&#10;GROUP BY ml.id, ounder.hierarchy, ml.currency_code, mc.account_no, ml.account_no, gua.lastname, g.display_name,&#10;cvc.code_value, cvn.code_value, cvl.code_value, cvs.code_value&#10;ORDER BY ounder.hierarchy, ml.currency_code, mc.account_no, ml.account_no&#10;"/>
            <where>report_name = 'Loan in arrears Table'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Collateral-report-fix-collateral-type" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Collateral';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select o.name    as Office, &#10;c.external_id     as UID, &#10;concat(c.firstname, ' ', c.lastname) as 'Customer Name', &#10;l.account_no     as 'Loan Id Number', &#10;mpl.name   as 'Product Name', &#10;l.principal_amount     as 'Loan Amount', &#10;cvs.code_value    as Strata, &#10;mcm.quality    as 'Type of Collateral', &#10;ccma.worth_of_collateral   as 'Collateral Coverage', &#10;''  as OMV, &#10;''    as FSV, &#10;cvp.code_value  as Province, &#10;cvd.code_value    as District, &#10;cvsec.code_value   as Sector, &#10;cvcell.code_value   as Cell, &#10;cvv.code_value    as Village&#10;from m_office o &#10;join m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%') and &#10; ounder.hierarchy like concat('${currentUserHierarchy}', '%') &#10;join m_client c on c.office_id = ounder.id&#10;join m_loan l on l.client_id = c.id &#10;join m_product_loan mpl on l.product_id = mpl.id &#10;left join m_client_other_info coi on coi.client_id = c.id &#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id &#10;left join m_client_collateral_management mccm on c.id = mccm.client_id &#10;left join m_loan_collateral_management lcm on mccm.id = lcm.client_collateral_id &#10;left join m_collateral_management mcm on mccm.collateral_id = mcm.id &#10;left join m_client_collateral_management_additional_details ccma &#10;on ccma.client_collateral_id = lcm.client_collateral_id &#10;left join m_code_value cvp on cvp.id = ccma.province_cv_id &#10;left join m_code_value cvd on cvd.id = ccma.district_cv_id &#10;left join m_code_value cvsec on cvsec.id = ccma.sector_cv_id &#10;left join m_code_value cvcell on cvcell.id = ccma.cell_cv_id  &#10;left join m_code_value cvv on cvv.id = ccma.village_cv_id&#10;where o.id = ${officeId} &#10;and (l.product_id = '${loanProductId}' or '-1' = '${loanProductId}')&#10;and (l.fund_id = '${fundId}' or '-1' = '${fundId}')&#10;and (l.loan_officer_id = '${loanOfficerId}' or '-1' = '${loanOfficerId}')&#10;and (ccma.province_cv_id = '${provinceId}' or '-1' = '${provinceId}')&#10;GROUP BY o.name, c.external_id, CONCAT(c.firstname, ' ', c.lastname), l.account_no, mpl.name, l.principal_amount,&#10;mcm.quality, mcm.unit_type,&#10;cvp.code_value, cvd.code_value, cvsec.code_value, cvcell.code_value, cvv.code_value, cvs.code_value,&#10;ccma.worth_of_collateral&#10;"/>
            <where>report_name = 'Collateral'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Loan-fully-repaid-Table-report-and-fix-cycle-column" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Loan fully repaid Table';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT c.id     AS 'id',&#10;c.firstname     AS 'firstName', &#10;c.middlename    AS 'middleName', &#10;c.lastname      AS 'lastName', &#10;c.display_name     AS 'fullName', &#10;c.mobile_no      AS 'mobileNo', &#10;l.principal_amount      AS 'loanAmount', &#10;(IFNULL(l.principal_outstanding_derived, 0) + IFNULL(l.interest_outstanding_derived, 0) + &#10;IFNULL(l.fee_charges_outstanding_derived, 0) + &#10;IFNULL(l.penalty_charges_outstanding_derived, 0))    AS 'loanOutstanding', &#10;l.principal_disbursed_derived     AS 'loanDisbursed', &#10;o.id      AS 'officeNumber', &#10;l.account_no    AS 'loanAccountId', &#10;gua.lastname     AS 'guarantorLastName', &#10;COUNT(gua.id)     AS 'numberOfGuarantors', &#10;l.maturedon_date     AS 'dueDate', &#10;laa.total_overdue_derived   AS 'totalDue', &#10;gp.display_name    AS 'groupName', &#10;l.total_repayment_derived      AS 'totalFullyPaid', &#10;year(now()) - YEAR(c.date_of_birth)      as 'Age', &#10;c.external_id     as 'Client UID', &#10;cdg.code_value      as 'Gender', &#10;cvc.code_value      as 'Cohort', &#10;l.generic_loan_counter     as 'Cycle',  &#10;cvn.code_value    as 'Nationality', &#10;cvl.code_value     as 'Location', &#10;cvs.code_value     AS 'Strata'&#10;FROM m_office o&#10;JOIN m_office ounder ON ounder.hierarchy LIKE CONCAT(o.hierarchy, '%')&#10;JOIN m_client c ON c.office_id = ounder.id&#10;JOIN m_loan l ON l.client_id = c.id&#10;LEFT JOIN m_staff lo ON lo.id = l.loan_officer_id&#10;LEFT JOIN m_currency cur ON cur.code = l.currency_code&#10;LEFT JOIN m_group_client gc ON gc.client_id = c.id&#10;LEFT JOIN m_group gp ON gp.id = l.group_id&#10;LEFT JOIN m_guarantor gua ON gua.loan_id = l.id&#10;LEFT JOIN m_loan_arrears_aging laa ON laa.loan_id = l.id&#10;left join m_client_other_info coi on coi.client_id = c.id&#10;left join m_code_value cdg on cdg.id = c.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = c.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;WHERE o.id = ${officeId}&#10;AND (IFNULL(l.loan_officer_id, -10) = ${loanOfficerId} OR '-1' = ${loanOfficerId})&#10;AND date(l.closedon_date) between date('${startDate}') and date('${endDate}')&#10;AND (l.loan_status_id IN (600, 700))&#10;GROUP BY l.id, ounder.hierarchy, l.currency_code, c.account_no, l.account_no, gua.lastname, l.maturedon_date, cvc.code_value,&#10; cvn.code_value, cvl.code_value, cvs.code_value&#10;ORDER BY ounder.hierarchy, l.currency_code, c.account_no, l.account_no&#10;"/>
            <where>report_name = 'Loan fully repaid Table'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Rescheduled-Loans_report_INKO-417-fix-reason-2" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Rescheduled Loans';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT concat(repeat('..', ((LENGTH(ounder.hierarchy) - LENGTH(REPLACE(ounder.hierarchy, '.', '')) - 1))), ounder.name)   as 'Office/Branch',&#10;coalesce(cur.display_symbol, ml.currency_code)  as 'Currency',&#10;c.account_no  as 'Client Account No.',&#10;c.display_name  AS 'Client Name',&#10;ml.account_no  AS 'Loan Account No.',&#10;mpl.name  AS 'Product Name',&#10;ml.disbursedon_date  AS 'Disbursed Date',&#10;ml.writtenoffon_date    AS 'Written Off date',&#10;ml.principal_amount  as 'Loan Amount',&#10;join_mlrr.reason   AS 'Reason For Rescheduling',&#10;coalesce(ms.display_name, '-')   AS 'Loan Officer Name', &#10;extract(year from now()) - extract(year from c.date_of_birth) as 'Age', &#10;c.external_id    as 'Client UID', &#10;cdg.code_value    as 'Gender',&#10;cvc.code_value   as 'Cohort',&#10;ml.generic_loan_counter   as 'Cycle',&#10;cvn.code_value   as 'Nationality',&#10;cvl.code_value     as 'Location',&#10;cvs.code_value     AS 'Strata',&#10;ml.loan_status_id     AS 'Loan Status'&#10;FROM m_office o&#10;JOIN m_office ounder ON ounder.hierarchy like concat(o.hierarchy, '%') AND  ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')&#10;JOIN m_client c ON c.office_id = ounder.id&#10;JOIN m_loan ml ON ml.client_id = c.id&#10;JOIN m_product_loan mpl ON mpl.id = ml.product_id&#10;JOIN (SELECT MAX(mlrr.id) AS id, mlrr.loan_id, cvs.code_value as reason,mlrr.reschedule_from_date as rescheduleDate&#10;FROM m_loan_reschedule_request mlrr&#10;left join m_code_value cvs on cvs.id = mlrr.reschedule_reason_cv_id&#10;WHERE mlrr.status_enum = 200&#10;GROUP BY mlrr.loan_id, cvs.code_value,mlrr.reschedule_from_date) join_mlrr ON join_mlrr.loan_id = ml.id&#10;LEFT JOIN m_staff ms ON ms.id = ml.loan_officer_id&#10;LEFT JOIN m_currency cur on cur.code = ml.currency_code&#10;left join m_client_other_info coi on coi.client_id = c.id&#10;left join m_code_value cdg on cdg.id = c.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = c.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;WHERE  o.id = ${officeId}&#10;AND (mpl.id = ${loanProductId} OR ${loanProductId} = -1)&#10;AND join_mlrr.rescheduleDate BETWEEN '${startDate}' AND '${endDate}'&#10;AND (ml.currency_code = '${currencyId}' or '-1' = '${currencyId}')&#10;ORDER BY ounder.hierarchy, coalesce(cur.display_symbol, ml.currency_code), ml.account_no&#10;"/>
            <where>report_name = 'Rescheduled Loans'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Update_Client-Statement-fix-loan-cycle" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Client Statement';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select l.id, &#10;o.name     as Office,  &#10;cvl.code_value        as 'Client Location', &#10;c.external_id       as UID, &#10;concat(c.firstname, ' ', c.lastname)        as 'Customer Name',  &#10;l.account_no        as 'Loan Id Number',  &#10;l.principal_amount          as 'Loan Amount',  &#10;l.interest_charged_derived       as Interest, &#10;l.term_frequency               as 'Total Payments',  &#10;l.principal_repaid_derived         as 'Total Principal Paid',  &#10;l.fee_charges_repaid_derived        as 'Total Fees Paid', &#10;l.interest_repaid_derived         as 'Total Interest Paid',  &#10;l.penalty_charges_charged_derived        as 'Total Late Fees', &#10;l.total_outstanding_derived           as 'Outstanding Balance',  &#10;l.interest_outstanding_derived     as 'Outstanding Interest',  &#10;l.fee_charges_outstanding_derived     as 'Outstanding Fees',  &#10;cvs.code_value     as 'Client Classification',   &#10;case  &#10;when (con.enabled = false) then loanStatusTable.loanStatus   &#10;when con.enabled = true then case     &#10;when loanStatusTable.loanStatus = 'Pending Approval' and    &#10;loanStatusTable.loanDecisionState is null    &#10;then loanStatusTable.loanStatus      &#10;when loanStatusTable.loanStatus = 'Pending Approval' and      &#10;loanStatusTable.loanDecisionState is not null and        &#10;loanStatusTable.loanDecisionState != 'Prepare And Sign Contract' &#10;then loanStatusTable.loanDecisionState  &#10;when loanStatusTable.loanStatus != 'Pending Approval'     &#10;then loanStatusTable.loanStatus      &#10;when loanStatusTable.loanStatus = 'Pending Approval' and   &#10; loanStatusTable.loanDecisionState = 'Prepare And Sign Contract'     &#10; then loanStatusTable.loanStatus end end as 'Status',      &#10;YEAR(now()) - YEAR(c.date_of_birth)                                              as Age,     &#10;cvg.code_value                                                                   as Gender,      &#10;cvc.code_value                                                                   as Cohort,   &#10;l.generic_loan_counter                                                           as Cycle,       &#10;cvn.code_value                                                                   as Nationality,       &#10;cvl.code_value                                                                   as Location &#10;from m_office o &#10;join m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%') and &#10;ounder.hierarchy like concat('${currentUserHierarchy}', '%')  &#10;join m_client c on c.office_id = ounder.id  &#10;join m_loan l on l.client_id = c.id  &#10;join m_product_loan pl on pl.id = l.product_id &#10;left join m_client_other_info coi on coi.client_id = c.id  &#10;left join m_client_recruitment_survey crs on crs.client_id = c.id  &#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id  &#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id    &#10;left join m_code_value cvg on cvg.id = c.gender_cv_id    &#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id    &#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id    &#10;left join m_fund f on f.id = l.fund_id    &#10;left join m_staff lo on lo.id = l.loan_officer_id   &#10;left join m_loan_decision ld on ld.loan_id = l.id  &#10;left join c_configuration con on con.name = 'Add-More-Stages-To-A-Loan-Life-Cycle' &#10;left join (select l.id   as loanId,    &#10;case   &#10;when l.loan_status_id = 100 then 'Pending Approval'   &#10;when l.loan_status_id = 200 then 'Approval' &#10;when l.loan_status_id = 300 then 'Active'  &#10;when l.loan_status_id = 303 then 'Transfer In Progress' &#10;when l.loan_status_id = 304 then 'Transfer On Hold'   &#10;when l.loan_status_id = 400 then 'Withdrawn By Client'    &#10;when l.loan_status_id = 500 then 'Rejected'    &#10;when l.loan_status_id = 600 then 'Closed Obligations Met'   &#10;when l.loan_status_id = 601 then 'Closed Written Off'     &#10;when l.loan_status_id = 602 then 'Closed Reschedule Outstanding Amount'   &#10;when l.loan_status_id = 700 then 'Overpaid' end                        as loanStatus,  &#10;case   &#10; when l.loan_decision_state = 1000 then 'Review Application'    &#10;when l.loan_decision_state = 1200 then 'Due Diligence'  &#10;when l.loan_decision_state = 1300 then 'Collateral Review' &#10;when l.loan_decision_state = 1400 then 'IC Review Level One'  &#10;when l.loan_decision_state = 1500 then 'IC Review Level Two'  &#10;when l.loan_decision_state = 1600 then 'IC Review Level Three'  &#10;when l.loan_decision_state = 1700 then 'IC Review Level Four'  &#10;when l.loan_decision_state = 1800 then 'IC Review Level Five'  &#10;when l.loan_decision_state = 1900   &#10;then 'Prepare And Sign Contract' end    as loanDecisionState    &#10;from m_loan l   &#10;left join m_loan_decision ld on ld.loan_id = l.id) as loanStatusTable  &#10;on loanStatusTable.loanId = l.id&#10;where o.id = ${officeId}  &#10;and (l.product_id = '${loanProductId}' or '-1' = '${loanProductId}')  &#10;and (l.fund_id = '${fundId}' or '-1' = '${fundId}')  &#10;and (ifnull(l.loan_officer_id, -10) = '${loanOfficerId}' or '-1' = '${loanOfficerId}')  &#10;and (l.disbursedon_date between date('${startDate}') and date('${endDate}'))  &#10;and (c.id = '${clientId}' or '-1' = '${clientId}')&#10;"/>
            <where>report_name = 'Client Statement'</where>
        </update>
    </changeSet>


    <changeSet author="bosco@fiter.io" id="Update_Rescheduled-Loans_report_change-date-filter-by-submitted-date-2" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Rescheduled Loans';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT concat(repeat('..', ((LENGTH(ounder.hierarchy) - LENGTH(REPLACE(ounder.hierarchy, '.', '')) - 1))), ounder.name)   as 'Office/Branch',&#10;coalesce(cur.display_symbol, ml.currency_code)  as 'Currency',&#10;c.account_no  as 'Client Account No.',&#10;c.display_name  AS 'Client Name',&#10;ml.account_no  AS 'Loan Account No.',&#10;mpl.name  AS 'Product Name',&#10;ml.disbursedon_date  AS 'Disbursed Date',&#10;ml.writtenoffon_date    AS 'Written Off date',&#10;join_mlrr.rescheduleDate  AS 'Reschedule Date',&#10;ml.principal_amount  as 'Loan Amount',&#10;join_mlrr.reason   AS 'Reason For Rescheduling',&#10;coalesce(ms.display_name, '-')   AS 'Loan Officer Name', &#10;extract(year from now()) - extract(year from c.date_of_birth) as 'Age', &#10;c.external_id    as 'Client UID', &#10;cdg.code_value    as 'Gender',&#10;cvc.code_value   as 'Cohort',&#10;ml.generic_loan_counter   as 'Cycle',&#10;cvn.code_value   as 'Nationality',&#10;cvl.code_value     as 'Location',&#10;cvs.code_value     AS 'Strata',&#10;ml.loan_status_id     AS 'Loan Status',     &#10;  join_mlrr.submittedOnDate AS 'Reschedule Request Date'&#10;FROM m_office o&#10;JOIN m_office ounder ON ounder.hierarchy like concat(o.hierarchy, '%') AND  ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')&#10;JOIN m_client c ON c.office_id = ounder.id&#10;JOIN m_loan ml ON ml.client_id = c.id&#10;JOIN m_product_loan mpl ON mpl.id = ml.product_id&#10;JOIN (SELECT MAX(mlrr.id) AS id, mlrr.loan_id, cvs.code_value as reason,mlrr.reschedule_from_date as rescheduleDate,mlrr.submitted_on_date AS submittedOnDate&#10;FROM m_loan_reschedule_request mlrr&#10;left join m_code_value cvs on cvs.id = mlrr.reschedule_reason_cv_id&#10;WHERE mlrr.status_enum = 200&#10;GROUP BY mlrr.loan_id, cvs.code_value,mlrr.reschedule_from_date,mlrr.submitted_on_date) join_mlrr ON join_mlrr.loan_id = ml.id&#10;LEFT JOIN m_staff ms ON ms.id = ml.loan_officer_id&#10;LEFT JOIN m_currency cur on cur.code = ml.currency_code&#10;left join m_client_other_info coi on coi.client_id = c.id&#10;left join m_code_value cdg on cdg.id = c.gender_cv_id&#10;left join m_client_recruitment_survey crs on crs.client_id = c.id&#10;left join m_code_value cvc on cvc.id = crs.cohort_cv_id&#10;left join m_code_value cvn on cvn.id = coi.nationality_cv_id&#10;left join m_code_value cvl on cvl.id = crs.survey_location_cv_id&#10;left join m_code_value cvs on cvs.id = coi.strata_cv_id&#10;WHERE  o.id = ${officeId}&#10;AND (mpl.id = ${loanProductId} OR ${loanProductId} = -1)&#10;AND join_mlrr.submittedOnDate BETWEEN '${startDate}' AND '${endDate}'&#10;AND (ml.currency_code = '${currencyId}' or '-1' = '${currencyId}')&#10;ORDER BY ounder.hierarchy, coalesce(cur.display_symbol, ml.currency_code), ml.account_no&#10;"/>
            <where>report_name = 'Rescheduled Loans'</where>
        </update>
    </changeSet>


    <changeSet author="bosco@fiter.io" id="update_Rwanda_Consumer_Credit_To_TransUnion_CRB_Report_mysql-5" context="mysql">
        <sqlFile
                encoding="utf8"
                path="db/changelog/tenant/commands/update_Rwanda_Consumer_Credit_To_TransUnion_CRB_Report_mysql5.sql"
                relativeToChangelogFile="false"
                splitStatements="true"
                stripComments="true"/>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="update_Rwanda_Corporate_Credit_To_TransUnion_CRB_Report_mysql-5" context="mysql">
        <sqlFile
                encoding="utf8"
                path="db/changelog/tenant/commands/update_Rwanda_Corporate_Credit_To_TransUnion_CRB_Report_mysql5.sql"
                relativeToChangelogFile="false"
                splitStatements="true"
                stripComments="true"/>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="ClientTrendsByDay-fix-sql" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'ClientTrendsByDay';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT 	COUNT(cl.id) AS count,&#10;cl.activation_date AS days&#10;FROM m_office x&#10;LEFT JOIN m_client cl on x.id = cl.office_id&#10;WHERE x.hierarchy like concat((select ino.hierarchy from m_office ino where ino.id = ${officeId}),'%' )&#10;AND (cl.activation_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 12 DAY) AND DATE(NOW()- INTERVAL 1 DAY))&#10;GROUP BY days&#10;"/>
            <where>report_name = 'ClientTrendsByDay'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="LoanTrendsByDay-fix-sql" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'LoanTrendsByDay';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT 	COUNT(ln.id) AS lcount,	&#10;ln.disbursedon_date AS days&#10;FROM m_office x	&#10;LEFT JOIN m_client cl on x.id = cl.office_id	&#10;LEFT JOIN m_loan ln on cl.id = ln.client_id&#10;WHERE x.hierarchy like concat((select ino.hierarchy from m_office ino where ino.id = ${officeId}),'%' )	&#10;AND (ln.disbursedon_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 12 DAY) AND DATE(NOW()- INTERVAL 1 DAY))&#10;GROUP BY days&#10;"/>
            <where>report_name = 'LoanTrendsByDay'</where>
        </update>
    </changeSet>


    <changeSet author="bosco@fiter.io" id="ClientTrendsByMonth-fix-sql" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'ClientTrendsByMonth';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10; SELECT 	COUNT(cl.id) AS count,&#10;MONTHNAME(cl.activation_date) AS Months&#10;FROM m_office x&#10;LEFT JOIN m_client cl on x.id = cl.office_id&#10;WHERE x.hierarchy like concat((select ino.hierarchy from m_office ino where ino.id = ${officeId}),'%' )&#10;AND (cl.activation_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 12 MONTH) AND DATE(NOW()))&#10;GROUP BY Months &#10;"/>
            <where>report_name = 'ClientTrendsByMonth'</where>
        </update>
    </changeSet>


    <changeSet author="bosco@fiter.io" id="LoanTrendsByMonth-fix-sql" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'LoanTrendsByMonth';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT 	COUNT(ln.id) AS lcount,	&#10;MONTHNAME(ln.disbursedon_date) AS Months&#10;FROM m_office x	&#10;LEFT JOIN m_client cl on x.id = cl.office_id	&#10;LEFT JOIN m_loan ln on cl.id = ln.client_id&#10;WHERE x.hierarchy like concat((select ino.hierarchy from m_office ino where ino.id = ${officeId}),'%' )&#10;AND (ln.disbursedon_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 12 MONTH) AND DATE(NOW()))&#10;GROUP BY Months&#10;"/>
            <where>report_name = 'LoanTrendsByMonth'</where>
        </update>
    </changeSet>


    <changeSet author="bosco@fiter.io" id="ClientTrendsByWeek-fix-sql" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'ClientTrendsByWeek';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT 	COUNT(cl.id) AS count,&#10;WEEK(cl.activation_date) AS Weeks&#10;FROM m_office x&#10;LEFT JOIN m_client cl on x.id = cl.office_id&#10;WHERE x.hierarchy like concat((select ino.hierarchy from m_office ino where ino.id = ${officeId}),'%' )&#10;AND (cl.activation_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 12 WEEK) AND DATE(NOW()))&#10;GROUP BY Weeks&#10;"/>
            <where>report_name = 'ClientTrendsByWeek'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="LoanTrendsByWeek-fix-sql" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'LoanTrendsByWeek';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;SELECT 	COUNT(ln.id) AS lcount,	&#10;WEEK(ln.disbursedon_date) AS Weeks&#10;FROM m_office x	&#10;LEFT JOIN m_client cl on x.id = cl.office_id	&#10;LEFT JOIN m_loan ln on cl.id = ln.client_id&#10;WHERE x.hierarchy like concat((select ino.hierarchy from m_office ino where ino.id = ${officeId}),'%' )&#10;AND (ln.disbursedon_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 12 WEEK) AND DATE(NOW()))&#10;GROUP BY Weeks&#10;"/>
            <where>report_name = 'LoanTrendsByWeek'</where>
        </update>
    </changeSet>

    <changeSet author="bosco@fiter.io" id="Demand_Vs_Collection-fix-sql" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Demand_Vs_Collection';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select amount.AmountDue-amount.AmountPaid as AmountDue, amount.AmountPaid as AmountPaid from&#10;(SELECT&#10;(IFNULL(SUM(ls.principal_amount),0) - IFNULL(SUM(ls.principal_writtenoff_derived),0) + IFNULL(SUM(ls.interest_amount),0) - IFNULL(SUM(ls.interest_writtenoff_derived),0) - IFNULL(SUM(ls.interest_waived_derived),0) + IFNULL(SUM(ls.fee_charges_amount),0) - IFNULL(SUM(ls.fee_charges_writtenoff_derived),0) - IFNULL(SUM(ls.fee_charges_waived_derived),0) + IFNULL(SUM(ls.penalty_charges_amount),0) - IFNULL(SUM(ls.penalty_charges_writtenoff_derived),0) - IFNULL(SUM(ls.penalty_charges_waived_derived),0)) AS AmountDue,&#10;(IFNULL(SUM(ls.principal_completed_derived),0) - IFNULL(SUM(ls.principal_writtenoff_derived),0) + IFNULL(SUM(ls.interest_completed_derived),0) - IFNULL(SUM(ls.interest_writtenoff_derived),0) - IFNULL(SUM(ls.interest_waived_derived),0) + IFNULL(SUM(ls.fee_charges_completed_derived),0) - IFNULL(SUM(ls.fee_charges_writtenoff_derived),0) - IFNULL(SUM(ls.fee_charges_waived_derived),0) + IFNULL(SUM(ls.penalty_charges_completed_derived),0) - IFNULL(SUM(ls.penalty_charges_writtenoff_derived),0) - IFNULL(SUM(ls.penalty_charges_waived_derived),0)&#10;) AS AmountPaid&#10;FROM m_office x&#10;LEFT JOIN m_client cl ON x.id = cl.office_id&#10;LEFT JOIN m_loan ln ON cl.id = ln.client_id&#10;LEFT JOIN m_loan_repayment_schedule ls ON ln.id = ls.loan_id&#10;WHERE ls.duedate = DATE(NOW()) AND &#10;(x.hierarchy LIKE CONCAT((&#10;SELECT ino.hierarchy&#10;FROM m_office ino&#10;WHERE ino.id = ${officeId}),'%'))) as amount&#10;"/>
            <where>report_name = 'Demand_Vs_Collection'</where>
        </update>
    </changeSet>


    <changeSet author="bosco@fiter.io" id="Disbursal_Vs_Awaitingdisbursal-fix-sql" context="mysql">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="stretchy_report"/>
            <sqlCheck expectedResult="1">
                select count(1) from stretchy_report
                where report_name = 'Disbursal_Vs_Awaitingdisbursal';
            </sqlCheck>
        </preConditions>
        <update tableName="stretchy_report">
            <column name="report_sql" value="&#10;select awaitinddisbursal.amount-disbursedAmount.amount as amountToBeDisburse, disbursedAmount.amount as disbursedAmount from&#10;(&#10;SELECT 	COUNT(ln.id) AS noOfLoans,			&#10;IFNULL(SUM(ln.principal_amount),0) AS amount&#10;FROM&#10;m_office x&#10;LEFT JOIN m_client cl ON cl.office_id = x.id&#10;LEFT JOIN m_loan ln ON cl.id = ln.client_id&#10;WHERE&#10;ln.expected_disbursedon_date = DATE(NOW()) AND&#10;(ln.loan_status_id=200 OR ln.loan_status_id=300) AND &#10;x.hierarchy like concat((select ino.hierarchy from m_office ino where ino.id = ${officeId}),'%' )&#10;) awaitinddisbursal,&#10;(&#10;SELECT 	COUNT(ltrxn.id) as count,			&#10;IFNULL(SUM(ltrxn.amount),0) as amount&#10;FROM&#10;m_office x&#10;LEFT JOIN m_client cl ON cl.office_id = x.id&#10;LEFT JOIN m_loan ln ON cl.id = ln.client_id&#10;LEFT JOIN m_loan_transaction ltrxn ON ln.id = ltrxn.loan_id&#10;WHERE&#10;ltrxn.transaction_date = DATE(NOW()) AND&#10;ltrxn.is_reversed = 0 AND&#10;ltrxn.transaction_type_enum=1 AND &#10;x.hierarchy like concat((select ino.hierarchy from m_office ino where ino.id = ${officeId}),'%' )&#10;) disbursedAmount&#10;"/>
            <where>report_name = 'Disbursal_Vs_Awaitingdisbursal'</where>
        </update>
    </changeSet>

    <changeSet id="update-column-acc_gl_journal_entry-type-from-int-to-string-2" author="bosco@fiter.io" context="postgresql">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="acc_gl_journal_entry" columnName="odoo_journal_id" />
        </preConditions>
        <sql>
            ALTER TABLE acc_gl_journal_entry
            ALTER COLUMN odoo_journal_id TYPE VARCHAR(255);
        </sql>
    </changeSet>
    <changeSet id="update-column-acc_gl_journal_entry-type-from-int-to-string-5" author="bosco@fiter.io" context="mysql">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="acc_gl_journal_entry" columnName="odoo_journal_id" />
        </preConditions>
        <sql>
            ALTER TABLE acc_gl_journal_entry
            MODIFY COLUMN odoo_journal_id VARCHAR(255);
        </sql>
    </changeSet>

    <changeSet id="insert-x_registered_table-for-failed_client_on_migration" author="bosco@fiter.io">
        <preConditions>
            <sqlCheck expectedResult="0">select count(*) from x_registered_table where registered_table_name = 'failed_client_on_migration'</sqlCheck>
        </preConditions>
        <sql>
            <![CDATA[
          INSERT INTO  x_registered_table (registered_table_name,application_table_name,entity_subtype,category) VALUES ('failed_client_on_migration','m_office',null,100);
             ]]>
        </sql>
    </changeSet>
    <changeSet id="create-failed_client_on_migration-data_table-1" author="bosco@fiter.io" context="mysql">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="failed_client_on_migration"/>
            </not>
        </preConditions>
        <createTable tableName="failed_client_on_migration">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"  />
            </column>
            <column name="office_Id" type="bigint" defaultValueNumeric="1">
                <constraints nullable="false" foreignKeyName="FK_failed_client_on_migration_office" references="m_office(id)"/>
            </column>
            <column name="external_Id"  type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="firstname"  type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="lastname"  type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="error_msg"  type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="created_at" type="datetime">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>


    <changeSet author="bosco@fiter.io" id="add_m_permission_CREATE_failed_client_on_migration">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM m_permission WHERE code = 'CREATE_failed_client_on_migration'
            </sqlCheck>
        </preConditions>
        <insert tableName="m_permission">
            <column name="grouping" value="datatable" />
            <column name="code" value="CREATE_failed_client_on_migration" />
            <column name="entity_name" value="failed_client_on_migration" />
            <column name="action_name" value="CREATE" />
            <column name="can_maker_checker" valueBoolean="true"/>
        </insert>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="add_m_permission_CREATE_failed_client_on_migration_CHECKER">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM m_permission WHERE code = 'CREATE_failed_client_on_migration_CHECKER'
            </sqlCheck>
        </preConditions>
        <insert tableName="m_permission">
            <column name="grouping" value="datatable" />
            <column name="code" value="CREATE_failed_client_on_migration_CHECKER" />
            <column name="entity_name" value="failed_client_on_migration" />
            <column name="action_name" value="CREATE" />
            <column name="can_maker_checker" valueBoolean="false"/>
        </insert>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="add_m_permission_READ_failed_client_on_migration">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM m_permission WHERE code = 'READ_failed_client_on_migration'
            </sqlCheck>
        </preConditions>
        <insert tableName="m_permission">
            <column name="grouping" value="datatable" />
            <column name="code" value="READ_failed_client_on_migration" />
            <column name="entity_name" value="failed_client_on_migration" />
            <column name="action_name" value="READ" />
            <column name="can_maker_checker" valueBoolean="false"/>
        </insert>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="add_m_permission_UPDATE_failed_client_on_migration">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM m_permission WHERE code = 'UPDATE_failed_client_on_migration'
            </sqlCheck>
        </preConditions>
        <insert tableName="m_permission">
            <column name="grouping" value="datatable" />
            <column name="code" value="UPDATE_failed_client_on_migration" />
            <column name="entity_name" value="failed_client_on_migration" />
            <column name="action_name" value="UPDATE" />
            <column name="can_maker_checker" valueBoolean="true"/>
        </insert>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="add_m_permission_UPDATE_failed_client_on_migration_CHECKER">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM m_permission WHERE code = 'UPDATE_failed_client_on_migration_CHECKER'
            </sqlCheck>
        </preConditions>
        <insert tableName="m_permission">
            <column name="grouping" value="datatable" />
            <column name="code" value="UPDATE_failed_client_on_migration_CHECKER" />
            <column name="entity_name" value="failed_client_on_migration" />
            <column name="action_name" value="UPDATE" />
            <column name="can_maker_checker" valueBoolean="false"/>
        </insert>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="add_m_permission_DELETE_failed_client_on_migration">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM m_permission WHERE code = 'DELETE_failed_client_on_migration'
            </sqlCheck>
        </preConditions>
        <insert tableName="m_permission">
            <column name="grouping" value="datatable" />
            <column name="code" value="DELETE_failed_client_on_migration" />
            <column name="entity_name" value="failed_client_on_migration" />
            <column name="action_name" value="DELETE" />
            <column name="can_maker_checker" valueBoolean="true"/>
        </insert>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="add_m_permission_DELETE_failed_client_on_migration_CHECKER">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM m_permission WHERE code = 'DELETE_failed_client_on_migration_CHECKER'
            </sqlCheck>
        </preConditions>
        <insert tableName="m_permission">
            <column name="grouping" value="datatable" />
            <column name="code" value="DELETE_failed_client_on_migration_CHECKER" />
            <column name="entity_name" value="failed_client_on_migration" />
            <column name="action_name" value="DELETE" />
            <column name="can_maker_checker" valueBoolean="false"/>
        </insert>
    </changeSet>


    <changeSet id="create-m_failed_client_creation_on_data_migration-2" author="bosco@fiter.io">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="m_failed_client_creation_on_data_migration"/>
            </not>
        </preConditions>
        <createTable tableName="m_failed_client_creation_on_data_migration">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"  />
            </column>
            <column name="office_Id" type="bigint" defaultValueNumeric="1">
                <constraints nullable="false" foreignKeyName="FK_m_failed_client_creation_on_data_migration_office" references="m_office(id)"/>
            </column>
            <column name="external_Id"  type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="client_type"  type="int">
                <constraints nullable="false"/>
            </column>
            <column name="firstname"  type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="lastname"  type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="error_msg"  type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="json_object"  type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="created_at" type="datetime" defaultValueComputed="now()">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-m_failed_loan_creation_on_data_migration-5" author="bosco@fiter.io" context="mysql">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="m_failed_loan_creation_on_data_migration"/>
            </not>
        </preConditions>
        <createTable tableName="m_failed_loan_creation_on_data_migration">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"  />
            </column>
            <column name="client_Id" type="long" >
                <constraints nullable="true" />
            </column>
            <column name="odoo_loan_number"  type="varchar(100)">
                <constraints nullable="false"   unique="true"/>
            </column>
            <column name="odoo_loan_id"   type="varchar(50)">
                <constraints nullable="true"/>
            </column>
            <column name="amount" type="decimal(19,6)">
                <constraints nullable="true"/>
            </column>
            <column name="error_msg"  type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="json_object"  type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="created_at" type="datetime" defaultValueComputed="now()">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-m_failed_loan_repayment_on_data_migration-5" author="bosco@fiter.io">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="m_failed_loan_repayment_on_data_migration"/>
            </not>
        </preConditions>
        <createTable tableName="m_failed_loan_repayment_on_data_migration">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"  />
            </column>
            <column name="loan_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="transaction_amount" type="decimal(19,6)">
                <constraints nullable="true"/>
            </column>
            <column name="note"   type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="transaction_date"   type="varchar(20)">
                <constraints nullable="true" />
            </column>
            <column name="payment_type"   type="int">
                <constraints nullable="true"/>
            </column>
            <column name="error_msg"  type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="json_object"  type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="created_at" type="datetime" defaultValueComputed="now()">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="Update_Portfolio-Management-Report-Table_loan_report_INKO-463" context="mysql">
        <sqlFile
                encoding="utf8"
                path="db/changelog/tenant/commands/INKO-463-update_portfolio_management_table_reports.sql"
                relativeToChangelogFile="false"
                splitStatements="true"
                stripComments="true"/>
    </changeSet>
    <changeSet id="update-m_permission-with-grouping-value-1" author="bosco@fiter.io" context="mysql">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">select count(*) from m_permission p  WHERE p.code = 'WITHDRAWAL_REDRAW_LOAN' AND p.entity_name = 'LOAN' AND p.action_name = 'WITHDRAWAL_REDRAW' AND p.`grouping` IS NULL</sqlCheck>
        </preConditions>
        <sql>
            <![CDATA[
          UPDATE m_permission p SET p.`grouping` = 'transaction_loan' WHERE p.code = 'WITHDRAWAL_REDRAW_LOAN' AND p.entity_name = 'LOAN' AND p.action_name = 'WITHDRAWAL_REDRAW' AND p.id > 0;
             ]]>
        </sql>
    </changeSet>
    <changeSet id="update-m_permission-with-grouping-value-for-PROVISIONING_ENTRIES-1" author="bosco@fiter.io" context="mysql">
        <sql>
            <![CDATA[
          UPDATE m_permission p SET  p.entity_name = 'PROVISIONCRITERIA'  WHERE  p.`grouping` = 'LOAN_PROVISIONING' AND   p.code = 'CREATE_PROVISIONCRITERIA' AND p.entity_name = 'PROVISIONINGCRITERIA' AND p.action_name = 'CREATE'  AND p.id > 0 ;
          UPDATE m_permission p SET  p.entity_name = 'PROVISIONCRITERIA'  WHERE  p.`grouping` = 'LOAN_PROVISIONING'  AND  p.code = 'UPDATE_PROVISIONCRITERIA' AND p.entity_name = 'PROVISIONINGCRITERIA' AND p.action_name = 'UPDATE'  AND p.id > 0 ;
          UPDATE m_permission p SET  p.entity_name = 'PROVISIONCRITERIA'  WHERE  p.`grouping` = 'LOAN_PROVISIONING'  AND  p.code = 'DELETE_PROVISIONCRITERIA' AND p.entity_name = 'PROVISIONINGCRITERIA' AND p.action_name = 'DELETE'  AND p.id > 0 ;

          UPDATE m_permission p SET  p.entity_name = 'PROVISIONENTRIES'  WHERE  p.`grouping` = 'LOAN_PROVISIONING' AND  p.code = 'CREATE_PROVISIONENTRIES' AND p.entity_name = 'PROVISIONINGENTRIES' AND p.action_name = 'CREATE'  AND p.id > 0 ;
          UPDATE m_permission p SET  p.entity_name = 'PROVISIONENTRIES'  WHERE  p.`grouping` = 'LOAN_PROVISIONING'  AND  p.code = 'CREATE_PROVISIONJOURNALENTRIES' AND p.entity_name = 'PROVISIONINGENTRIES' AND p.action_name = 'CREATE'  AND p.id > 0 ;
          UPDATE m_permission p SET  p.entity_name = 'PROVISIONENTRIES'  WHERE  p.`grouping` = 'LOAN_PROVISIONING'  AND   p.code = 'RECREATE_PROVISIONENTRIES' AND p.entity_name = 'PROVISIONINGENTRIES' AND p.action_name = 'RECREATE'  AND p.id > 0 ;
             ]]>
        </sql>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="add_loan_contract_document_id_for_migration">

        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="m_document" columnName="data_migration_loan_number"/>
            </not>
        </preConditions>
        <addColumn tableName="m_document">
            <column name="data_migration_loan_number" type="VARCHAR(500)">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet author="bosco@fiter.io" id="INKO-546-update_portfolio_management_table_reports-4" context="mysql">
        <sqlFile
                encoding="utf8"
                path="db/changelog/tenant/commands/INKO-546-update_portfolio_management_table_reports.sql"
                relativeToChangelogFile="false"
                splitStatements="true"
                stripComments="true"/>
    </changeSet>

</databaseChangeLog>
